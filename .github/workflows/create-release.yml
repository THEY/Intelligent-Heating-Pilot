name: Create Pre-Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.3.0

permissions:
  contents: write
  issues: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for changelog generation
      
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
      
      - name: Check if release notes exist
        id: check_notes
        run: |
          NOTES_FILE="GITHUB_RELEASE_${{ steps.version.outputs.tag }}.md"
          if [ -f "$NOTES_FILE" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "file=$NOTES_FILE" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release body
        id: release_body
        run: |
          if [ "${{ steps.check_notes.outputs.exists }}" == "true" ]; then
            # Use prepared release notes
            cat "${{ steps.check_notes.outputs.file }}" > release_body.md
            echo "" >> release_body.md
            echo "---" >> release_body.md
            echo "" >> release_body.md
            echo "**Issues Fixed in This Release:**" >> release_body.md
            # Extract issue numbers from release notes
            grep -oP '(?<=\[#)\d+(?=\])' "${{ steps.check_notes.outputs.file }}" | sort -u | while read issue; do
              echo "Closes #$issue" >> release_body.md
            done
          else
            # Fallback: Generate from CHANGELOG.md
            echo "# Release ${{ steps.version.outputs.tag }}" > release_body.md
            echo "" >> release_body.md
            echo "See [CHANGELOG.md](./CHANGELOG.md) for details." >> release_body.md
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "${{ steps.version.outputs.tag }} - Beta Release"
          body_path: release_body.md
          draft: false
          prerelease: true  # Mark as pre-release for beta versions
          generate_release_notes: false  # Use our custom notes
          files: |
            CHANGELOG.md
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Close issues referenced in release notes
        if: steps.check_notes.outputs.exists == 'true'
        run: |
          # Extract issue numbers and close them
          grep -oP '(?<=\[#)\d+(?=\])' "${{ steps.check_notes.outputs.file }}" | sort -u | while read issue; do
            echo "Closing issue #$issue"
            gh issue close "$issue" --comment "Fixed in release ${{ steps.version.outputs.tag }}"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update project board
        if: steps.check_notes.outputs.exists == 'true'
        run: |
          # Move closed issues to "Done" column
          grep -oP '(?<=\[#)\d+(?=\])' "${{ steps.check_notes.outputs.file }}" | sort -u | while read issue; do
            echo "Moving issue #$issue to Done"
            # GitHub CLI will automatically update project board status
            gh issue edit "$issue" --add-label "released"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
